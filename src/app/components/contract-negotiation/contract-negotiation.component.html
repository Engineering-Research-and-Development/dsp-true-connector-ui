<div *ngIf="loading" class="item">
  <mat-card class="service-card">
    <ngx-skeleton-loader count="15" appearance="line" animation="pulse" />
  </mat-card>
</div>

<div *ngIf="!loading">
  <mat-card class="service-card">
    <mat-card-title class="service-title"> </mat-card-title>
    <mat-card-content>
      <div class="headtitle">
        <div class="back">
          <h1 *ngIf="userType === 'provider'">
            Manage contract offers as provider
          </h1>
          <h1 *ngIf="userType === 'consumer'">
            Manage contract offers as consumer
          </h1>
          <mat-icon
            *ngIf="userType === 'provider'"
            class="help-icon"
            matTooltip="Here you can view all contract negotiation where you act as a provider. You can filter them by state, and respond differently based on current state to other consumer who started Contract Negotiation."
            aria-label="Help regarding contract negotiation management"
            >help_outline</mat-icon
          >
          <mat-icon
            *ngIf="userType === 'consumer'"
            class="help-icon"
            matTooltip="Here you can view all contract negotiation where you act as a consumer. You can filter them by state, and respond differently based on current state to other providers."
            aria-label="Help regarding contract negotiation management"
            >help_outline</mat-icon
          >
        </div>
        <div class="buttons">
          <button
            mat-button
            matTooltip="Refresh data"
            (click)="fetchContractNegotiations()"
          >
            <mat-icon>cached</mat-icon>
          </button>
        </div>
      </div>
      <div class="filter-div">
        <mat-expansion-panel
          class="filter-expansion-panel"
          [(expanded)]="filterExpansionState.filtersExpanded"
        >
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>filter_list</mat-icon>
              Advanced Filters
            </mat-panel-title>
            <mat-panel-description>
              Filter contract negotiations by state, offer ID, provider PID, and
              consumer PID
            </mat-panel-description>
          </mat-expansion-panel-header>

          <div class="filter-content">
            <div class="filter-fields-row">
              <!-- State Filter - Dropdown with Single Selection -->
              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Filter by State</mat-label>
                <mat-select
                  [(value)]="selectedState"
                  placeholder="Select state"
                >
                  <mat-option [value]="null">All States</mat-option>
                  <mat-option
                    *ngFor="let state of contractNegotiationStates"
                    [value]="state"
                  >
                    {{ getStateDisplayName(state) }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <!-- Offer ID Filter -->
              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Offer ID</mat-label>
                <input
                  matInput
                  [(ngModel)]="offerIdFilter"
                  placeholder="Enter offer ID"
                />
              </mat-form-field>

              <!-- Provider PID Filter -->
              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Provider PID</mat-label>
                <input
                  matInput
                  [(ngModel)]="providerPidFilter"
                  placeholder="Enter provider PID"
                />
              </mat-form-field>

              <!-- Consumer PID Filter -->
              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Consumer PID</mat-label>
                <input
                  matInput
                  [(ngModel)]="consumerPidFilter"
                  placeholder="Enter consumer PID"
                />
              </mat-form-field>

              <!-- Filter Action Buttons -->
              <div class="filter-actions-inline">
                <button
                  mat-raised-button
                  color="primary"
                  (click)="applyFilters()"
                >
                  <mat-icon>search</mat-icon>
                  Apply
                </button>
                <button mat-button (click)="clearFilters()">
                  <mat-icon>clear</mat-icon>
                  Clear
                </button>
              </div>
            </div>
          </div>
        </mat-expansion-panel>
      </div>
      <div class="space-card">
        <div *ngFor="let contractNegotiation of contractNegotiations">
          <div class="card">
            <div class="title">
              {{ contractNegotiation["@id"] }}
            </div>
            <div class="subtitle">
              {{ contractNegotiation.type }}
            </div>
            <div class="content">
              <p>
                <strong>Assigner:</strong>
                {{ contractNegotiation.assigner }}
              </p>
              <p>
                <strong>Callback address:</strong>
                {{ contractNegotiation.callbackAddress }}
              </p>
              <p>
                <strong>Provider PID:</strong>
                {{ contractNegotiation.providerPid }}
              </p>
              <p>
                <strong>Consumer PID:</strong>
                {{ contractNegotiation.consumerPid }}
              </p>
              <p>
                <strong>State:</strong>
                {{ contractNegotiation.state }}
              </p>
              <p>
                <strong>Created:</strong>
                {{ contractNegotiation.created | date : "d MMMM y, HH:mm:ss" }}
              </p>
              <p>
                <strong>Modified:</strong>
                {{ contractNegotiation.modified | date : "d MMMM y, HH:mm:ss" }}
              </p>

              <div *ngIf="contractNegotiation.offer !== null">
                <h3>Offer details</h3>
                <div>
                  <p>
                    <strong>ID:</strong>
                    {{ contractNegotiation.offer["@id"] }}
                  </p>
                  <p>
                    <strong>Target:</strong>
                    {{ contractNegotiation.offer.target }}
                  </p>
                  <mat-expansion-panel
                    class="expansion-panel"
                    *ngIf="contractNegotiation.offer.permission.length > 0"
                  >
                    <mat-expansion-panel-header>
                      <mat-panel-title>Permissions</mat-panel-title>
                    </mat-expansion-panel-header>
                    <div
                      *ngFor="
                        let permission of contractNegotiation.offer.permission
                      "
                      class="resource-section"
                    >
                      <div>
                        <p>
                          <strong>Action:</strong>
                          {{ permission.action }}
                        </p>
                        <p>
                          <strong>Assigner:</strong>
                          {{ permission.assigner }}
                        </p>
                        <p>
                          <strong>Target:</strong>
                          {{ permission.target }}
                        </p>
                        <div
                          *ngFor="let constraint of permission.constraint"
                          class="constraint-section"
                        >
                          <div>
                            <p>
                              <strong>Constraint:</strong>
                            </p>
                            <p>
                              <strong>Left operand:</strong>
                              {{ constraint.leftOperand }}
                            </p>
                            <p>
                              <strong>Operator:</strong>
                              {{ constraint.operator }}
                            </p>
                            <p>
                              <strong>Right operand:</strong>
                              {{ constraint.rightOperand }}
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </mat-expansion-panel>
                </div>
              </div>
            </div>
            <div class="btn-action">
              <!-- Conditionally show buttons based on state -->
              <button
                mat-button
                matTooltip="Approve contract"
                *ngIf="
                  contractNegotiation.state ===
                    contractNegotiationState.REQUESTED &&
                  userType === 'provider'
                "
                (click)="onApprove(contractNegotiation)"
              >
                <mat-icon>check</mat-icon>
                <p>Approve</p>
              </button>
              <button
                mat-button
                matTooltip="Accept contract"
                *ngIf="
                  contractNegotiation.state === contractNegotiationState.OFFERED
                "
                (click)="onAccept(contractNegotiation)"
              >
                <mat-icon>check</mat-icon>
                <p>Accept</p>
              </button>
              <button
                mat-button
                matTooltip="Verify contract"
                *ngIf="
                  contractNegotiation.state ===
                    contractNegotiationState.AGREED && userType === 'consumer'
                "
                (click)="onVerify(contractNegotiation)"
              >
                <mat-icon>check</mat-icon>
                <p>Verify</p>
              </button>
              <button
                mat-button
                matTooltip="Finalize contract"
                *ngIf="
                  contractNegotiation.state ===
                    contractNegotiationState.VERIFIED && userType === 'provider'
                "
                (click)="onFinalize(contractNegotiation)"
              >
                <mat-icon>check</mat-icon>
                <p>Finalize</p>
              </button>
              <button
                mat-button
                matTooltip="Terminate contract"
                *ngIf="
                  contractNegotiation.state !==
                    contractNegotiationState.FINALIZED &&
                  contractNegotiation.state !==
                    contractNegotiationState.TERMINATED
                "
                (click)="onTerminate(contractNegotiation)"
              >
                <mat-icon>cancel</mat-icon>
                <p>Terminate</p>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Pagination Controls -->
      <mat-paginator
        *ngIf="paginationState.totalElements > 0"
        [length]="paginationState.totalElements"
        [pageSize]="paginationState.pageSize"
        [pageIndex]="paginationState.pageIndex"
        [pageSizeOptions]="paginationState.pageSizeOptions"
        (page)="onPageChange($event)"
        showFirstLastButtons
        aria-label="Select page of contract negotiations"
      >
      </mat-paginator>
    </mat-card-content>
  </mat-card>
</div>
